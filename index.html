<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Camilo Assistant 路 UCJC</title>

<style>
:root{
  --ucjc-burgundy:#7A0019;
  --ucjc-burgundy-dark:#5C0013;
  --ucjc-gold:#C9A227;
  --bg:#0E1117;
  --panel:#171B24;
  --text:#F5F5F5;
}

body{
  margin:0;
  background:var(--bg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  color:var(--text);
}

.chat{
  width:95%;
  max-width:900px;
  height:90vh;
  background:var(--panel);
  border-radius:16px;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  box-shadow:0 25px 60px rgba(0,0,0,.5);
}

.header{
  background:linear-gradient(90deg,var(--ucjc-burgundy),var(--ucjc-burgundy-dark));
  padding:18px;
  font-weight:700;
  letter-spacing:.5px;
}

.messages{
  flex:1;
  padding:18px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.message{
  max-width:75%;
  padding:12px 16px;
  border-radius:14px;
  line-height:1.5;
  white-space:pre-wrap;
}

.user{
  background:rgba(201,162,39,.15);
  align-self:flex-end;
}

.bot{
  background:rgba(122,0,25,.35);
  align-self:flex-start;
}

.input-area{
  display:flex;
  padding:14px;
  border-top:1px solid rgba(255,255,255,.08);
}

textarea{
  flex:1;
  resize:none;
  border:none;
  border-radius:12px;
  padding:12px;
  font-size:14px;
  outline:none;
}

button{
  margin-left:10px;
  padding:12px 20px;
  border:none;
  border-radius:12px;
  background:var(--ucjc-burgundy);
  color:white;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}

button:hover{
  background:#8F001E;
}
</style>
</head>
<body>

<div class="chat">
  <div class="header">Camilo Assistant 路 UCJC</div>
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <textarea id="input" placeholder="Escribe tu pregunta..."></textarea>
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
const API_URL = "https://airia-proxy.paulgarghe23.workers.dev/chat";

// ===== USER ID persistente por navegador =====
let userId = localStorage.getItem("ucjcUserId");
if(!userId){
  userId = crypto.randomUUID();
  localStorage.setItem("ucjcUserId", userId);
}

const messages = document.getElementById("messages");
const input = document.getElementById("input");

function addMessage(text, role){
  const div = document.createElement("div");
  div.className = "message " + role;
  div.textContent = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function extractAnswer(data){

  // Caso 1: string simple
  if(typeof data.result === "string"){
    return data.result;
  }

  // Caso 2: array de steps
  if(Array.isArray(data.result)){
    const lastWithOutput = data.result
      .filter(step => step.output)
      .pop();

    if(lastWithOutput){
      return lastWithOutput.output;
    }
  }

  return "No se recibi贸 respuesta v谩lida.";
}

async function sendMessage(){
  const text = input.value.trim();
  if(!text) return;

  addMessage(text,"user");
  input.value="";

  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        userInput:text,
        asyncOutput:false,
        userId:userId
      })
    });

    const data = await res.json();

    if(!res.ok){
      addMessage("Error de conexi贸n con el servidor.","bot");
      console.error(data);
      return;
    }

    const answer = extractAnswer(data);
    addMessage(answer,"bot");

  }catch(err){
    addMessage("Error de red.","bot");
    console.error(err);
  }
}

input.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

addMessage("隆Hola!  Soy Camilo Assistant. 驴En qu茅 puedo ayudarte?","bot");
</script>

</body>
</html>
